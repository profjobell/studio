<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sermon Extractor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loader {
      border: 4px solid #f3f3f3; /* Light grey */
      border-top: 4px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
    <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Church Sermon Extractor</h1>
    
    <div class="mb-4">
      <label for="youtube-url" class="block text-sm font-medium text-gray-700 mb-1">YouTube Video URL</label>
      <input
        type="text"
        id="youtube-url"
        placeholder="e.g., https://www.youtube.com/watch?v=VIDEO_ID"
        class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      />
    </div>

    <button
      id="process-button"
      onclick="processSermon()"
      class="w-full bg-blue-600 text-white p-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed"
    >
      <span id="process-button-text">Process Sermon</span>
      <span id="process-button-loader" class="loader hidden"></span>
    </button>
    
    <div class="mt-6">
      <label for="sermon-output" class="block text-sm font-medium text-gray-700 mb-1">Sermon Text</label>
      <textarea
        id="sermon-output"
        readonly
        class="mt-1 block w-full p-3 border border-gray-300 rounded-md h-64 shadow-sm bg-gray-50"
        placeholder="Extracted sermon text will appear here..."
      ></textarea>
    </div>

    <button
      id="copy-button"
      onclick="copySermonText()"
      class="mt-3 w-full bg-green-500 text-white p-3 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors hidden"
    >
      Copy Sermon Text to Clipboard
    </button>
    
    <p id="status-message" class="mt-3 text-sm text-center"></p>

    <div class="mt-6 text-center">
      <button
        onclick="history.back()"
        class="w-auto bg-gray-500 text-white p-3 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
      >
        &larr; Back to KJV Sentinel
      </button>
    </div>
     <p class="text-xs text-gray-400 mt-4 text-center">
        This tool uses Kome.ai (external service) for transcription. Please ensure you comply with Kome.ai's terms of service.
    </p>
  </div>

  <script>
    const urlInput = document.getElementById('youtube-url');
    const outputTextarea = document.getElementById('sermon-output');
    const statusMessage = document.getElementById('status-message');
    const processButton = document.getElementById('process-button');
    const processButtonText = document.getElementById('process-button-text');
    const processButtonLoader = document.getElementById('process-button-loader');
    const copyButton = document.getElementById('copy-button');

    // More comprehensive regex
    const YOUTUBE_URL_REGEX = /^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/)|youtu\.be\/)([\w-]{11})(?:\S+)?$/;

    async function processSermon() {
      const url = urlInput.value;

      if (!url || !YOUTUBE_URL_REGEX.test(url)) {
        statusMessage.textContent = 'Please provide a valid YouTube video URL.';
        statusMessage.className = 'mt-3 text-sm text-center text-red-600';
        copyButton.classList.add('hidden');
        return;
      }

      statusMessage.textContent = 'Processing...';
      statusMessage.className = 'mt-3 text-sm text-center text-blue-600';
      outputTextarea.value = '';
      processButton.disabled = true;
      processButtonText.classList.add('hidden');
      processButtonLoader.classList.remove('hidden');
      copyButton.classList.add('hidden');

      try {
        // This will call your Firebase Cloud Function
        const response = await fetch('/processSermon', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ url })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Server responded with an error: ' + response.statusText }));
            throw new Error(errorData.error || 'Failed to process sermon. Status: ' + response.status);
        }

        const data = await response.json();

        if (data.error) {
          statusMessage.textContent = data.error;
          statusMessage.className = 'mt-3 text-sm text-center text-red-600';
          copyButton.classList.add('hidden');
        } else {
          outputTextarea.value = data.sermon || "";
          statusMessage.textContent = data.warning ? data.warning : 'Processing complete.';
          statusMessage.className = data.warning ? 'mt-3 text-sm text-center text-yellow-600' : 'mt-3 text-sm text-center text-green-600';
          if (data.sermon && data.sermon !== "No sermon content could be identified in the transcript.") {
            copyButton.classList.remove('hidden');
            // Automatic copy can be intrusive, so let user click the button.
            // await navigator.clipboard.writeText(data.sermon);
            // statusMessage.textContent += ' Sermon text copied to clipboard.';
          } else {
            copyButton.classList.add('hidden');
          }
        }
      } catch (error) {
        console.error('Error processing sermon:', error);
        statusMessage.textContent = 'Error: ' + error.message;
        statusMessage.className = 'mt-3 text-sm text-center text-red-600';
        copyButton.classList.add('hidden');
      } finally {
        processButton.disabled = false;
        processButtonText.classList.remove('hidden');
        processButtonLoader.classList.add('hidden');
      }
    }

    async function copySermonText() {
        const textToCopy = outputTextarea.value;
        if (!textToCopy) {
            statusMessage.textContent = 'No sermon text to copy.';
            statusMessage.className = 'mt-3 text-sm text-center text-yellow-600';
            return;
        }
        try {
            await navigator.clipboard.writeText(textToCopy);
            statusMessage.textContent = 'Sermon text copied to clipboard!';
            statusMessage.className = 'mt-3 text-sm text-center text-green-600';
        } catch (err) {
            statusMessage.textContent = 'Failed to copy text. Please copy manually.';
            statusMessage.className = 'mt-3 text-sm text-center text-red-600';
            console.error('Failed to copy text: ', err);
        }
    }
  </script>
</body>
</html>
