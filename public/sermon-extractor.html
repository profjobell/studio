<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sermon Extractor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loader {
      border: 2px solid #f3f3f3; /* Light grey */
      border-top: 2px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
    <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">Church Sermon Extractor</h1>
    <p class="text-sm text-gray-600 mb-4">
      This tool helps isolate sermon content from full church service transcripts.
      First, obtain your transcript from a service like 
      <a href="https://kome.ai/tools/youtube-transcript-generator" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Kome.ai YouTube Transcript Generator</a>.
      Then, paste the ENTIRE transcript below and click "Isolate Sermon".
    </p>
    <div class="mb-4">
      <label for="transcript-input" class="block text-sm font-medium text-gray-700">Pasted Full Transcript:</label>
      <textarea
        id="transcript-input"
        placeholder="Paste the full transcript here, including timestamps, music cues, announcements, etc."
        class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-40"
      ></textarea>
    </div>
    <button
      id="process-button"
      onclick="processPastedSermon()"
      class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 flex items-center justify-center"
    >
      <span id="process-button-text">Isolate Sermon from Pasted Text</span>
      <span id="loader" class="loader hidden"></span>
    </button>
    <div class="mt-4">
      <label for="sermon-output" class="block text-sm font-medium text-gray-700">Isolated Sermon Text:</label>
      <textarea
        id="sermon-output"
        readonly
        class="mt-1 block w-full p-2 border border-gray-300 rounded-md h-64 bg-gray-50"
      ></textarea>
    </div>
    <button
      id="copy-button"
      onclick="copySermonText()"
      class="w-full mt-2 bg-green-500 text-white p-2 rounded-md hover:bg-green-600 hidden"
    >
      Copy Sermon Text
    </button>
    <div id="status-message-container" class="mt-2 min-h-[20px]"> 
      <p id="status-message" class="text-sm"></p>
    </div>
    <div class="mt-6 text-center">
        <button
            onclick="javascript:history.back()"
            class="text-sm text-blue-600 hover:text-blue-800 hover:underline"
        >
            &larr; Back to KJV Sentinel App
        </button>
    </div>
    <p class="text-xs text-gray-500 mt-4 text-center">
      Please ensure your use of transcription services like Kome.ai complies with their terms of service.
    </p>
  </div>

  <script>
    const transcriptInput = document.getElementById('transcript-input');
    const outputTextarea = document.getElementById('sermon-output');
    const statusDiv = document.getElementById('status-message');
    const copyButton = document.getElementById('copy-button');
    const processButton = document.getElementById('process-button');
    const processButtonText = document.getElementById('process-button-text');
    const loader = document.getElementById('loader');

    function setStatus(message, type = 'info') {
      statusDiv.textContent = message;
      if (type === 'error') {
        statusDiv.className = 'text-sm text-red-600';
      } else if (type === 'success') {
        statusDiv.className = 'text-sm text-green-600';
      } else {
        statusDiv.className = 'text-sm text-gray-600';
      }
    }

    function setLoadingState(isLoading) {
      if (isLoading) {
        processButton.disabled = true;
        processButtonText.textContent = 'Processing...';
        loader.classList.remove('hidden');
        copyButton.classList.add('hidden');
        outputTextarea.value = '';
      } else {
        processButton.disabled = false;
        processButtonText.textContent = 'Isolate Sermon from Pasted Text';
        loader.classList.add('hidden');
      }
    }

    async function processPastedSermon() {
      const pastedText = transcriptInput.value;

      if (!pastedText.trim()) {
        setStatus('Please paste a transcript into the input field.', 'error');
        return;
      }

      setLoadingState(true);
      setStatus('Processing transcript...');

      try {
        const response = await fetch('/processSermon', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ transcript: pastedText })
        });

        if (!response.ok) {
          let errorDetail = `Server responded with status: ${response.status}`;
          try {
            // Try to parse as JSON first, as the CF might send a JSON error
            const errorData = await response.clone().json(); // Clone to read body multiple times if needed
            if (errorData && errorData.error) {
              errorDetail = errorData.error;
            } else {
              // If not JSON, read as text (likely HTML)
              const rawErrorBody = await response.text();
              console.error("Received non-JSON error response from server. Status:", response.status, "Body:", rawErrorBody);
              if (rawErrorBody.toLowerCase().includes("<!doctype html>")) {
                errorDetail = `Server returned an HTML error page (Status: ${response.status}). Please check Cloud Function logs.`;
              } else {
                errorDetail = `Server error (Status: ${response.status}). Response: ${rawErrorBody.substring(0, 100)}...`;
              }
            }
          } catch (e) {
            // Fallback if parsing error response itself fails
            const rawErrorBody = await response.text();
            console.error("Error parsing error response body from server. Status:", response.status, "Raw Body:", rawErrorBody);
            errorDetail = `Server returned an unparsable error (Status: ${response.status}). Check console.`;
          }
          setStatus(errorDetail, 'error');
          setLoadingState(false);
          return;
        }

        const data = await response.json();

        if (data.error) {
          setStatus(data.error, 'error');
          copyButton.classList.add('hidden');
        } else {
          outputTextarea.value = data.sermon || "";
          if (data.sermon && data.sermon !== "No sermon content could be identified in the transcript.") {
            setStatus('Sermon isolated successfully. You can now copy the text.', 'success');
            copyButton.classList.remove('hidden');
          } else if (data.sermon === "No sermon content could be identified in the transcript.") {
            setStatus(data.sermon, 'info');
            copyButton.classList.add('hidden');
          } else {
            setStatus('Processing complete, but no sermon text was returned.', 'info');
             copyButton.classList.add('hidden');
          }
          if (data.warning) {
             setStatus(statusDiv.textContent + ' Warning: ' + data.warning, 'info');
          }
        }
      } catch (error) {
        console.error('Client-side error processing sermon:', error);
        setStatus('Client-side error: ' + error.message, 'error');
        copyButton.classList.add('hidden');
      } finally {
        setLoadingState(false);
      }
    }

    async function copySermonText() {
      const sermonText = outputTextarea.value;
      if (!sermonText) {
        setStatus('No sermon text to copy.', 'error');
        return;
      }
      try {
        await navigator.clipboard.writeText(sermonText);
        setStatus('Sermon text copied to clipboard!', 'success');
      } catch (err) {
        console.error('Failed to copy text: ', err);
        setStatus('Failed to copy sermon text. Please copy it manually.', 'error');
      }
    }
  </script>
</body>
</html>
