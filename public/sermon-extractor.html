<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sermon Extractor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loader {
      border: 4px solid #f3f3f3; /* Light grey */
      border-top: 4px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
    <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">Church Sermon Extractor</h1>
    <p class="text-sm text-gray-600 mb-1">
      This tool helps isolate sermon content from a full church service transcript.
    </p>
    <p class="text-sm text-gray-600 mb-4">
      For best results, obtain a transcript from a service like 
      <a href="https://kome.ai/tools/youtube-transcript-generator" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Kome.ai YouTube Transcript Generator</a>,
      paste the full transcript below, then click "Isolate Sermon".
    </p>

    <div class="mb-4">
      <label for="transcript-input" class="block text-sm font-medium text-gray-700">
        Paste Full Transcript Here:
      </label>
      <textarea
        id="transcript-input"
        placeholder="Paste the entire transcript from Kome.ai or another source..."
        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 h-40"
      ></textarea>
    </div>

    <button
      id="process-button"
      onclick="processPastedSermon()"
      class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-70 flex items-center justify-center"
    >
      <span id="button-text">Isolate Sermon from Pasted Text</span>
      <span id="button-loader" class="loader hidden ml-2"></span>
    </button>

    <div class="mt-6">
      <label for="sermon-output" class="block text-sm font-medium text-gray-700">Isolated Sermon Text:</label>
      <textarea
        id="sermon-output"
        readonly
        class="mt-1 block w-full p-2 border border-gray-300 rounded-md h-64 bg-gray-50"
      ></textarea>
    </div>
    <button
      id="copy-button"
      onclick="copySermonText()"
      class="mt-2 w-full bg-green-500 text-white p-2 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 hidden"
    >
      Copy Sermon Text to Clipboard
    </button>
    <p id="status-message" class="mt-2 text-sm"></p>

    <div class="mt-6 text-center">
        <button 
            onclick="javascript:history.back()" 
            class="text-sm text-blue-500 hover:underline focus:outline-none"
        >
            &larr; Back to KJV Sentinel
        </button>
    </div>
    <p class="text-xs text-gray-400 mt-4 text-center">
        Please ensure your use of any third-party transcription service like Kome.ai complies with their terms of service.
    </p>
  </div>

  <script>
    const processButton = document.getElementById('process-button');
    const buttonText = document.getElementById('button-text');
    const buttonLoader = document.getElementById('button-loader');
    const outputTextarea = document.getElementById('sermon-output');
    const statusMessage = document.getElementById('status-message');
    const copyButton = document.getElementById('copy-button');
    const transcriptInput = document.getElementById('transcript-input');

    async function processPastedSermon() {
      const transcript = transcriptInput.value;

      if (!transcript.trim()) {
        statusMessage.textContent = 'Please paste a transcript into the input field.';
        statusMessage.className = 'mt-2 text-sm text-red-600';
        copyButton.classList.add('hidden');
        return;
      }

      buttonText.textContent = 'Processing...';
      buttonLoader.classList.remove('hidden');
      processButton.disabled = true;
      outputTextarea.value = '';
      statusMessage.textContent = 'Processing transcript with AI... this may take a moment.';
      statusMessage.className = 'mt-2 text-sm text-blue-600';
      copyButton.classList.add('hidden');

      try {
        const response = await fetch('/processSermon', { // This still calls your Firebase Cloud Function
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ transcript: transcript }) // Send the pasted transcript
        });
        
        // Check if the response is JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const data = await response.json();
            if (response.ok) {
                if (data.error) {
                    statusMessage.textContent = data.error;
                    statusMessage.className = 'mt-2 text-sm text-red-600';
                } else {
                    outputTextarea.value = data.sermon || "No sermon content could be extracted by AI.";
                    if (data.sermon && data.sermon !== "No sermon content could be identified in the transcript." && data.sermon !== "No sermon content could be extracted by AI.") {
                        statusMessage.textContent = 'Sermon isolated by AI! Ready to copy.';
                        statusMessage.className = 'mt-2 text-sm text-green-600';
                        copyButton.classList.remove('hidden');
                    } else {
                        statusMessage.textContent = data.sermon || "No sermon content identified by AI.";
                        statusMessage.className = 'mt-2 text-sm text-yellow-600';
                    }
                    if (data.warning) {
                        statusMessage.textContent += ` Warning: ${data.warning}`;
                    }
                }
            } else {
                 statusMessage.textContent = `Error: ${response.status} ${response.statusText}. ${data.error || 'Failed to process sermon via AI.'}`;
                 statusMessage.className = 'mt-2 text-sm text-red-600';
            }
        } else {
            // Handle non-JSON responses (like HTML error pages)
            const textResponse = await response.text();
            console.error("Received non-JSON response:", textResponse);
            statusMessage.textContent = `Error: Server returned an unexpected response (Status: ${response.status}). Check console for details.`;
            statusMessage.className = 'mt-2 text-sm text-red-600';
        }

      } catch (error) {
        console.error('Error in processPastedSermon:', error);
        statusMessage.textContent = 'Client-side error processing sermon: ' + error.message;
        statusMessage.className = 'mt-2 text-sm text-red-600';
      } finally {
        buttonText.textContent = 'Isolate Sermon from Pasted Text';
        buttonLoader.classList.add('hidden');
        processButton.disabled = false;
      }
    }

    function copySermonText() {
        const sermonText = outputTextarea.value;
        if (!sermonText) {
            statusMessage.textContent = 'Nothing to copy.';
            statusMessage.className = 'mt-2 text-sm text-yellow-600';
            return;
        }
        navigator.clipboard.writeText(sermonText).then(() => {
            statusMessage.textContent = 'Sermon text copied to clipboard!';
            statusMessage.className = 'mt-2 text-sm text-green-600';
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            statusMessage.textContent = 'Failed to copy sermon text. Please copy manually.';
            statusMessage.className = 'mt-2 text-sm text-red-600';
        });
    }
  </script>
</body>
</html>
